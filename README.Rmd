---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# `R/rw`: Robins & Wang multiple imputation variance estimator

<!-- badges: start -->
[![R-CMD-check](https://github.com/LucyMcGowan/rw/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/LucyMcGowan/rw/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/LucyMcGowan/rw/graph/badge.svg)](https://app.codecov.io/gh/LucyMcGowan/rw)
<!-- badges: end -->

The purpose of the `rw` package is to compute [Robins-Wang variance estimates](https://doi.org/10.1093/biomet/87.1.113) for multiply imputed data analyses.

## Installation

This package requires the development version of mice with the `tasks` argument:

```r
remotes::install_github("amices/mice@dev")
```

Then you can install the development version of `rw` like so:

``` r
remotes::install_github("LucyMcGowan/rw")
```


## Example

The first step is to impute your data using `mice`. Note that currently only `method = "norm"` and `method = "logreg"` are supported. When using the `mice` function, you must set the parameter `tasks = "train"` in order to pass the necessary parts to our subsequent functions. For example, see below. We will use the `nhanes` data from the mice package and perform multiple imputation using the `norm` method.

```{r}
#| message: false
library(rw)
library(mice)
set.seed(1)
nhanes_scaled <- as.data.frame(scale(nhanes))

imp <- mice(nhanes_scaled, 
            method = "norm",
            m = 5, 
            tasks = "train",
            print = FALSE)
```

Now, suppose we want to fit a model predicting `bmi` from `age` and `hyp`. The `with_rw` function allows this, where the first argument is the imputation object from the `mice` function above and the second is the model expression. Note that currently outcome models must be Gaussian or Binomial.

```{r}
fit <- with_rw(imp, lm(bmi ~ age + hyp))
```

Finally, we can pool the results from the fit object and calculate the Robins-Wang variance using the `pool_rw` function

```{r}
pool_rw(fit)
```

Let's compare this result to using Rubin's rules.

```{r}
fit_rr <- with(imp, lm(bmi ~ age + hyp))
pool(fit_rr) |>
  summary()
```



## Giganti & Shepherd Example


Below is an example to replicate the [Giganti & Shepherd (2020)](https://doi.org/10.1093/aje/kwaa153) results.

```{r example}
set.seed(1)
meth <- make.method(giganti_data)
meth[] <- ""
meth[c("A", "D")] <- c("norm", "logreg")

pred <- make.predictorMatrix(giganti_data)
pred[,] <- 0
pred["A", c("X1", "X2", "A.star", "D.star")] <- 1
pred["D", c("X1", "X2", "A.star", "D.star", "A")] <- 1

imp <- mice(giganti_data, m = 10, method = meth, predictorMatrix = pred,
            print = FALSE, tasks = "train")

fit_rw <- with_rw(imp, glm(D ~ A, subset = A > 2, family = binomial()))

pooled <- pool_rw(fit_rw)
pooled

```


